<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Party Vote</title>

<style>
body {
  margin: 0;
  background: #0f1220;
  color: #fff;
  font-family: system-ui;
  display: flex;
  justify-content: center;
  padding: 20px;
}
.app { max-width: 420px; width: 100%; }
.card {
  background: #1a1f3a;
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 14px;
}
h1, h3 { text-align: center; }
.song { text-align: center; font-size: 22px; }
.artist { color: #aaa; text-align: center; }
.downvotes { text-align: center; color: #ff7a7a; font-size: 18px; }
.progress { height: 10px; background: #333; border-radius: 10px; overflow: hidden; }
.fill { height: 100%; background: #ff5c5c; width: 0%; }
.buttons { display: flex; gap: 10px; margin-top: 12px; }
button { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 18px; }
.up { background: #4ade80; }
.down { background: #ff5c5c; }
.item { display: flex; justify-content: space-between; margin-top: 8px; }
</style>
</head>

<body>
<div class="app">
<h1>ğŸ‰ Party Vote</h1>

<div class="card">
  <div class="song" id="song">Loadingâ€¦</div>
  <div class="artist" id="artist"></div>
  <div class="downvotes" id="downvotes"></div>
  <div class="progress"><div class="fill" id="fill"></div></div>
  <div class="buttons">
    <button class="up" onclick="vote('up')">ğŸ‘</button>
    <button class="down" onclick="vote('down')">ğŸ‘</button>
  </div>
</div>

<div class="card">
  <h3>ğŸ’€ Most Downvoted</h3>
  <div id="leaderboard"></div>
</div>
</div>

<script>
const BASE = "https://party-vote-backend.onrender.com";
const THRESHOLD = 5;

const device =
  localStorage.device_id ||
  (localStorage.device_id = crypto.randomUUID());

async function load() {
  const r = await fetch(`${BASE}/current`);
  const d = await r.json();

  if (!d.spotify_track_id) return;

  song.textContent = d.track_name;
  artist.textContent = d.artist;
  downvotes.textContent = `ğŸ‘ ${d.downvotes}`;
  fill.style.width = `${(d.downvotes / THRESHOLD) * 100}%`;
}

async function vote(v) {
  const r = await fetch(`${BASE}/vote`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ device_id: device, vote: v }),
  });
  const d = await r.json();
  if (!r.ok) return;
  downvotes.textContent = `ğŸ‘ ${d.downvotes}`;
  fill.style.width = `${((THRESHOLD - d.remaining) / THRESHOLD) * 100}%`;
}

async function loadLeaderboard() {
  const r = await fetch(`${BASE}/analytics/most-downvoted`);
  const d = await r.json();
  leaderboard.innerHTML = "";
  d.forEach((s, i) => {
    leaderboard.innerHTML += `
      <div class="item">
        <span>${i + 1}. ${s.track_name}</span>
        <strong>ğŸ‘ ${s.total}</strong>
      </div>`;
  });
}

load();
loadLeaderboard();
setInterval(load, 5000);
setInterval(loadLeaderboard, 20000);
</script>
</body>
</html>
